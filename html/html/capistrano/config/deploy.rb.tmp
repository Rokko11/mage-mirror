set :application, "%%%APPLICATION%%%"
set :user, "%%%WEBNUMMER%%%"
set :repository, "git@git.intern.iwelt.de:magento/#{application}.git"
set :scm, :git
set :use_sudo, false

set :deploy_to, "/var/www/#{user}/htdocs"
set :deploy_via, :copy
set :app_webroot, "/html"

# Or: `accurev`, `bzr`, `cvs`, `darcs`, `subversion`, `mercurial`, `perforce`, `subversion` or `none`

desc "Aufruf: cap stage deploy"
task :stage do
  set :env, "stage"
  set :hostname, "%%%SCPHOST%%%"
  role :web, hostname # Your HTTP server, Apache/etc
  role :app, hostname # This may be the same as your `Web` server or a separate administration server
end

desc "Aufruf: cap dev deploy"
task :dev do
  set :env, "dev"
  set :hostname, "shop01-dev.iwelt-ag.net"
  role :web, hostname # Your HTTP server, Apache/etc
  role :app, hostname # This may be the same as your `Web` server or a separate administration server
end

desc "Aufruf: cap prod deploy"
task :prod do
  set :env, "prod"
  set :hostname, "shop01.iwelt-ag.net"
  role :web, hostname # Your HTTP server, Apache/etc
  role :app, hostname # This may be the same as your `Web` server or a separate administration server
end


set :branch do
  default_tag = `git tag`.split("\n").find_all{|e| e.end_with?(env)}.last

  tag = Capistrano::CLI.ui.ask "Tag to deploy (make sure to push the tag first): [#{default_tag}] "
  tag = default_tag if tag.empty?
  tag
end


set :keep_releases, 3

after "deploy:setup", :copy_local_xml
after :deploy, "deploy:cleanup"


set :app_symlinks, ["/html/media", "/html/var", "/html/public"]
set :app_shared_dirs, ["/html/app/etc", "/html/media/wysiwyg", "/html/var", "/html/public"]
set :app_shared_files, ["/html/app/etc/local.xml", "/html/.htaccess"]

task :copy_local_xml do
  upload "../../html/.htaccess.#{env}", "#{deploy_to}/shared/html/.htaccess", :via => :scp, :recursive => false
end
